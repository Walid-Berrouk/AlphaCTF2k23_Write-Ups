# Token

## Description

> Can you gain admin access and retrieve the flag?
> 
> https://challenges.ctf.alphabit.club:1400 

## Tags

> medium Crypto, Web

## Write-Up

When we first enter the website, we get the following code :

```py
from flask import Flask, request
import jwt, time, os

app = Flask(__name__)
app.config["SECRET_KEY"] = os.urandom(24)

private_key = open("priv").read()
public_key = open("pub").read()
flag = open("flag.txt").read()


@app.route("/get_token")
def get_token():
    return jwt.encode(
        {"admin": False, "now": time.time()}, private_key, algorithm="RS256"
    )


@app.route("/get_flag", methods=["POST"])
def get_flag():
    try:
        payload = jwt.decode(request.form["jwt"], public_key, algorithms=["RS256"])
        if payload["admin"]:
            return flag
    except:
        return ":("


@app.route("/")
def main():
    return "

%s

" % open(__file__).read()


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
```

First we get a token :

```
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsIm5vdyI6MTY3NzkxODMyMC44ODc3Mzk0fQ.D8vcWy_Ib9WTPsmeCaaj2FBrSZ4WIiMskVqVQM9cYeqKRAMDbrc9LP3P-Ps2qy0DGYGvkJkNk_Vc_LzG5RnDHplj2hNgNH4HdgDywTNbNsUeOazf3QOw3ixvL4YLnk48qg
```

```
└─$ john jwt.txt --wordlist=/usr/share/wordlists/rockyou.txt
Warning: detected hash type "HMAC-SHA256", but the string is also recognized as "HMAC-SHA512"
Use the "--format=HMAC-SHA512" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 256/256 AVX2 8x])
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:01 DONE (2023-03-04 09:29) 0g/s 9194Kp/s 9194Kc/s 9194KC/s $121/2..*7¡Vamos!
Session completed. 
```

```
https://challenges.ctf.alphabit.club:1400/get_flag?jwt=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsIm5vdyI6MTY3NzkxODMyMC44ODc3Mzk0fQ.D8vcWy_Ib9WTPsmeCaaj2FBrSZ4WIiMskVqVQM9cYeqKRAMDbrc9LP3P-Ps2qy0DGYGvkJkNk_Vc_LzG5RnDHplj2hNgNH4HdgDywTNbNsUeOazf3QOw3ixvL4YLnk48qg
```

```
└─$ curl "https://challenges.ctf.alphabit.club:1400/get_flag" -X POST
:(
```

```
└─$ curl "https://challenges.ctf.alphabit.club:1400/get_flag" -X POST --data "jwt=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsIm5vdyI6MTY3NzkxODMyMC44ODc3Mzk0fQ.D8vcWy_Ib9WTPsmeCaaj2FBrSZ4WIiMskVqVQM9cYeqKRAMDbrc9LP3P-Ps2qy0DGYGvkJkNk_Vc_LzG5RnDHplj2hNgNH4HdgDywTNbNsUeOazf3QOw3ixvL4YLnk48qg"
<!doctype html>
<html lang=en>
<title>500 Internal Server Error</title>
<h1>Internal Server Error</h1>
<p>The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.</p>

┌──(rivench㉿kali)-[~/…/CTFs/AlphaCTF2k23/web-exploitation/Token]
└─$ curl "https://challenges.ctf.alphabit.club:1400/get_flag" -X POST --data "jwt=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsIm5vdyI6MTY3NzkxODMyMC44ODc3Mzk0fQ.D8vcWy_Ib9WTPsmeCaaj2FBrSZ4WIiMskVqVQM9cYeqKRAMDbrc9LP3P-Ps2qy0DGYGvkJkNk_Vc_LzG5RnDHplj2hNgNH4HdgDywTNbNsUeOazf3QOw3ixvL4YLnk48qg"
<!doctype html>
<html lang=en>
<title>500 Internal Server Error</title>
<h1>Internal Server Error</h1>
<p>The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.</p>

```

After searching for some vulns :

> **Change the algorithm RS256(asymmetric) to HS256(symmetric) (CVE-2016-5431/CVE-2016-10555)**
>
> The algorithm HS256 uses the secret key to sign and verify each message.
> 
> The algorithm RS256 uses the private key to sign the message and uses the public key for authentication.
> 
> If you change the algorithm from RS256 to HS256, the back end code uses the public key as the secret key and then uses the HS256 algorithm to verify the signature
> 
> Then, using the public key and changing RS256 to HS256 we could create a valid signature. You can retrieve the certificate of the web server executing this:

We might also check some vulnerabilities on `RS256` algorithm and try to leak public key to do some decoding.


## Flag



## More Information

 - Cracking jwt signature : https://shauryasharma05.medium.com/cracking-jwt-signature-90fd444fe494
 - Vulnerabilities in JWT : https://debricked.com/blog/json-web-tokens/
 - Hacking JWt : https://book.hacktricks.xyz/pentesting-web/hacking-jwt-json-web-tokens
 - Verification key in jwt : https://blog.pentesteracademy.com/hacking-jwt-tokens-verification-key-mismanagement-1b69c89ffdfb
